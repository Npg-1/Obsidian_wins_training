# 1. 악성코드 개요 #

## 악성코드 또는 악성 소프트웨어 ##

#### > 악성코드란? ####
- 컴퓨터, 서버, 클라이언트, 네트워크에 악영향을 끼칠 수 있는 모든 소프트웨어의 총칭
- "정상적"인 기능을 위해 만들어진 것이 아닌, 사용자의 해악을 끼치는 "악의적" 용도로 만들어짐
- 사회 기반 시설에서부터 산업 기밀을 목적으로 기업을 대상으로 사용
- 이전에는 구현 방식에 따라 바이러스, 웜, 트로이목마로 구분하였으나, 최근에는 행위에 기반을 두어 분류

#### > 형태 ####
- PE 파일 (exe, sys, dll, cab, ...)
- 문서 파일(doc, ppt, xls, rtf, pdf, hwp, ...)
- 미디어 파일(swf, jpg, mp4, avi, ...)
- 기타 (html, jar, apk, js, ...)



## 악성코드 감염 경로 ##

- 웹하드, P2P
- 홈페이지 은닉, ActiveX 자동 설치
- 이메일, 메신저
- 네트워크 취약점
- USB
- 침해사고



## 악성코드 분석 방법론 ##

\* 아래로 갈 수록 난이도가 어렵다고 보면 됨
- 완전 자동화 분석
- 정적 속성 분석
- 대화형 동적 분석
- 수동 코드 역공학 분석(상세 분석)

#### > 완전 자동화 분석(Full-automated Analysis) ####
- 자동화 도구를 사용하여 분석 (Hybrid Analysis, Cuckoo sandbox, Anyruns sandbox 등)
- 정적 분석과 동적 분석을 자동화하여 악성코드 정보를 빠르고 쉽게 획득 

#### > 정적 속성 분석(static properties analysis) ####
- 악성코드를 실행시키지 않고 정보를 획득하는 분석 방법
- 문자열 헤더 정보, Hash값, 리소스 정보, 패킹 여부 등을 확인
- 대부분 패킹 되어 있는 경우가 많아 유의미한 정보를 얻기가 쉽지 않음

#### > 대화형 동적 분석(Interactive Behavior ANalysis) ####
- 악성코드를 모니터링 도구의 감시 하에 실행시키는 방법
- 악성코드가 사용하는 API의 호출, 레지스트리 기록 등 악성 행위에 발생하는 변화 확인
- 주로 사용하는 도구: Process Explorer, Process Monitor, TCPView, Autorun 등

#### > 수동 코드 역공학 분석(Manual code reversing) ####
- 자동화 분석, 정적 분석, 동적 분석 이후 추가적인 정보를 획득하기 위해 분석하는 행위
- 특정 루틴에 난독화가 되어 있어 복호화가 이루어지는 부분을 더 분석하여 추가적인 정보 획득
- 악의적인 도메인 생성 과정의 알고리즘 분석
- 행동 분석 과정에서 자신을 숨기고 보여주지 않았던 부분으로 발생되는 다른 기능 이해



---
# 2. 악성코드 자동화 분석 #

## 악성코드 자동화 분석 개요 ##

#### > 샌드박스 ####
- 격리된 공간을 제공하여 그 공간에서 벗어나 허용되지 않은 작업을 하지 못하도록 방지하는 기술
- 가상 PC에 악성코드를 실행 및 행위를 기록하고 분석
- 악성코드 내부의 설정 데이터, C2 등의 데이터를 쉽게 추출 가능하다는 장점 존재

#### > 대표적인 무료 샌드박스 도구 ####
- Anyrun
- Cape
- Hybrid-analysis
- Cuckoo



## 악성코드 자동화 분석 도구 ##

#### > Cuckoo ####
- Windows, Linux, macOS 및 Android 가상화 환경에서 파일 및 URL 분석

#### > Cuckoo 샌드박스 구조 ####
- Cuckoo Host
- Analysis Guest
- Virtual Network



## 프로그램 실행 구조 ##

#### > PE 파일(Poratble Executable) ####
- 윈도우 운영체제에서 사용하는 실행 파일 형식

#### > PE 파일 종류 ####
- 실행 파일 계열: EXE, SCR
- 라이브러리 계열: DLL, OCX, CPL, DRV
- 드라이버 계열: SYS, VXD
- 오브젝트 계열: OBJ

- \[그림]



## PE 파일 분석 ##

#### > PE 파일 구조 ####
- PE파일 윈도우에서 만든 프로그램이 실행되기 위해 준수해야 하는 일종의 규칙
- 윈도우에서 프로그램 개발 후 실행 파일로 컴파일(Compile) 시 PE 형식으로 만들어짐

#### > IMAGE_DOS_HEADER ####
- 문자열

#### > MS-DOS Stub Program ####
- 문자열

#### > IMAGE_NT_HEADERS ####
- 문자열

#### > IMAGE_NT_HEADERS ####
- 문자열


#### > PE 파일(notepad.exe) ####
- 문자열


#### > IMAGE_DOS_HEADER ####
- Signature: 파일의 구조를 알 수 있음. 4D 5A(MZ)는 PE구조를 뜻함. 다른 파일들의 시그니쳐로는 50 4B(ZIP), 25 50 44 46(PDF), 89 50 4E 47(PNG) 등이 존재함

#### > MS-DOS Stub Program ####
- 사용자가...


#### > IMAGE_NT_HEADERS의 signature ####
- 사용자가...
- PE/0/0 은 불변임. 이게 바뀌어 있으면 변조된 것



## 시그니처를 통한 확장자 변경 실습 ##

파일의 시그니처(Signature)는 파일의 가장 앞부분에 기록되어 있는 특정 바이트 패턴으로 어떤 파일인지 알려주는 역할을함. 보안이나 포렌식 분야에서는 시그니처를 매직 넘버라고 부르기도함

| 파일 형식 | 시그니처 (16진수 값) | 설명                                   |
| ----- | ------------- | ------------------------------------ |
| JPEG  | FF D8 FF E0   | 이미지 파일의 시작                           |
| PNG   | 89 50 4E 47   | PNG 파일 (ASCII로 보면 'PNG'포함)           |
| PDF   | 25 50 44 46   | PDF 파일 (ASCII로 '%PDF' 시작)            |
| ZIP   | 50 4B 03 04   | 압축 파일 (개발자 Phill Katz의 이니셜 'PK'로 시작) |

예를 들어서 악성 사용자가 virus.exe라는 파일이 있을 때 해당 파일을 boodee.jpg로 파일 이름과 확장자를 바꿀 수 있지만 시그니처는 바뀌지 않기에 백신 프로그램이 파일의 시그니처를 보고 "JPEG가 아니라 EXE인데? 그럼 죽어"를 할 수 있음

재미있는 게 .zip의 시그니처인 (50 4B 03 04)는 압축 파일에서도 쓰이지만 word의 .docx와 한글의 .hwpx와 공통적으로 쓰임
.docx와 .hwpx는 모두 내부적으로 ZIP 압축 형식을 기반으로 구조화되어 있기 때문에 아래의 형식들은 모두 동일한 시그니처를 공유함
- 압축파일 : zip/jar(자바 압축파일)
- MS 오피스 문서: docx/xlsx/pptx
- 한글 문서: hwpx
- 구글 어스: kmz

컴퓨터는 시그니처를 보고 해당 파일의 파일 형식을 판단하는데 \[50 4B 03 04] 와 같은 시그니처 뒤의 특정 문자열을 더 읽어보고 내용중에 'word/' 가 있으면 .docx, 'xl/'가 있으면 .xlsx 로 판단하는 등의 작업을 거침



JPEG -> (16진수) FF D8 FF E0 -> (10진수) 255 216 255 224 -> 



25 50 44 46 -> % P D F








시그니처 샘플 압축파일 풀면 안에 시그니처 파일 1개와 집파일 한 개
시그니처는 확장자가 없음
시그니처의 확장자를 찾아서 시그니처 부분의 값을 바꿀 수 있음
헥사값을 파일에 맞는 확장자 값으로 바꾸기

cuckoo의 sample을 






1. Preview 문제에 보면 signature와 Sample.zip 이라는 두 파일이 있음
2. signature의 시그니처를 확인하고 이 시그니처를 통해 확장자를 유추해 signature의 확장자를 변경
	- \* 모든 파일이 그런 것은 아니지만 어떤 파일들은 하나의 파일이 여러 개의 확장자를 가질 수 있음! 
3. signature에서 비밀번호를 알아내서 해당 비밀번호로 Sample.zip를 열기





































