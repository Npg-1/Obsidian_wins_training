# I. APT 공격의 이해 #

## 1. APT 공격 개요 ##
- APT(Advanced Persistent Threat)는 잠행적이고 지속적인 컴퓨터 해킹 프로세스들의 집합으로, 특정 실체를 목표로 하는 사람이나 사람들에 의해 종종 지휘된다.
- DDoS, 방화벽, IPS는 네트워크 패킷을 다루지만 APT는 파일을 다룸

## APT 공격 절차 ##
공격 대상을 정함 -> 다양한 방법을 통해 악성코드를 유포 -> 침투 -> 거점을 확보 -> 관리자(Admin) 권한 획득 -> 정보 유출


---
## 2. APT 공격 사례 ##
- Wannacry(2017~2019): 랜섬웨어로 사내의 공유 폴더, 프린터기 등이 PC와 연결되어 있는데 그 연결에 취약점을 통해 정보를 탈취함

## 3. APT 공격 기법 ##

## 사회공학기법 ##
- 사람의 취약점과 실수를 공략하여 원하는 정보를 얻는 공격 기법

- ### 사회공학기법의 예시 ###
	- #### 피싱####
		- 전자우편 또는 메신저를 사용해서 신뢰할 수 있는 사람 또는 기업이 보낸 메시지를 가장해서 비밀번호 및 신용카드 정보와 같은 중요한 정보를 탈취하는 기법
			- \***스피어 피싱**: 일반적인 피싱은 포괄적이며 표적화를 하지 않아서 대상이 많은 사람과 기업을 대상으로 하지만 스피어 피싱은 대상을 특정해서 해당 조직에 침투하기 위해 만든 공격으로 대상을 특정하기 때문에 좀 더 치명적이고 막기 어려움
		- ##### 전형적인 절차 #####
			- 시스템 해킹 후 위장 홈페이지 준비 -> 피싱메일 발송 -> 메일내용에 현혹되어 본문의 링크 클릭 -> 위장 홈페이지에 개인정보 입력 -> 수집한 개인정보로 사기
	- #### 워터링 홀 ####
		- 웹 취약점을 이용한 공격으로 타겟이 자주 들어가는 홈페이지를 파악했다가 홈페이지의 취약점을 통해 악성코드를 심어 사용자가 악성코드를 다운받게 하고 다운로드 된 악성코드를 통해 정보를 얻는 공격 기법
		- ##### 전형적인 절차 #####
			1) 공격자는 해킹할 대상이 자주 접속하는 사이트(A 사이트)에 대한 정보를 수집함
			2) A 사이트의 취약점 등을 이용하여 A 사이트에다가 악성코드를 감염시킴
			3) 해킹 대상이 A사이트를 접속하여 악성코드에 감염됨
	- #### 베이팅 ####
		- 피해자를 특정해 놓지 않고 누군가는 걸리라는 방식으로 일반인들이 해킹 수법이라는 생각이 들지 않는 방법으로 미끼를 여기저기 뿌리는 방식임
		  와 진짜 뒤지게 
		- ##### 대표적인 사례 #####
			- 회사 로비나 복도에 USB를 떨어뜨려 놓음
			- 회사 임직원 중 누군가 USB를 줍고 내용이 궁금하잖아? 그래서 확인해봄
			- 감염됨!ㅋㅋ
	- APT 공격이 늘어나는 이유가 DDoS, 방화벽 등에서 네트워크 공격은 많이 막혀서 APT같은 게 더 효울이 좋아서 늘어나는 듯


---
## 랜섬 웨어 ##
- 컴퓨터 시스템을 감염시켜 접근을 제한하고 일종의 몸값을 요구하는 악성 소프트웨어의 한 종류임


홈페이지 방문, 이메일.SNS 유포


|  구분  |        홈페이지 방문        |        이메일/SNS 유포         |      웜(자기전파)      |    타깃형(APT) 공격     |
| :--: | :-------------------: | :-----------------------: | :---------------: | :----------------: |
| 감염방법 | 랜섬웨어가 유포중인<br>홈페이지 방문 | 첨부 파일 다운로드,<br>링크 실행 시 감염 | 컴퓨터 부팅 시<br>자동 감염 | 서버 침투 및<br>악성코드 설치 |
|      |                       |                           |                   |                    |
|      |                       |                           |                   |                    |


---
## 4. APT 대응 방안 ##
- #### 관리적 보안 ####
	- 보안조직구성, 관리 절차 및 규정
	- 사례 바탕 정기적 내부 인원 교육
	- 보안 감사, 보안 사고 조사/조치
- #### 물리적 보안 ####
	- 사업장, 주요시설(서버실) 출입 관리
	- 주요 자료 주기적 백업
	- 자산 반/출입 관리
- #### 기술적 보안 ####
	- APT 대응 전용 솔루션 구축
	- 인터넷망, 업무망 망분리 구성
	- 네트워크/End-Point 솔루션 최신화

### APT 공격 예방 10가지 방안(KISA) ###
- 조직의 핵심 자산을 파악하라
- 경영진부터 일반 직원까지 보안 필요성을 인식하라
- 체계적인 보안을 위해 보안 관리체계를 구축하라
- CERT 등 IT 보안을 위한 전담 팀을 구축하라
- 핵심 자산의 접근은 최소 인원만 허가하고 관리하라
- 사용자 별 접근권한을 다르게 설정하라
- 외부로부터의 공격, 내부로부터의 정보 유출 지점을 파악하라
- 필요한 경우 망을 분리하라
- 보안 업데이트, 최신 백신을 설치하고, 악성코드 침투를 예방하라
- 핵심 자산을 보호하기 위해 보안솔루션을 도입하라







---
---
# II. SNIPER ART 소개 #

## 1. SNIPER ART 개요 ##

- 세션 추적 및 감염자 추출
- VM웨어를 통해 샌드박스 기반 동적 분석
- 랜섬웨어 탐지/차단
- 악성코드 유포자, C&C 서버 추출
- 표준 탐지정책(YARA) 연동
- 분석정보 공유(PCAP, 원본파일)


### 대략적인 탐지 절차 ###
1) 파일수집
2) 정적 분석
3) 동적 분석
4) 파일 분석 보고서
5) 정책 배포
6) 탐지/차단


---
### 2. SNIPER APT 파일 분석 ###

##### 가상 머신 우회 탐지 #####
-> 악성파일들이 똑똑해서 VM과 실제 PC를 구분하는 악성파일이 있음, 그래서 실제 PC와 유사하게 VM을 구성함

##### 확장자 변환 파일 탐지 #####
- 클릭 방식이 아닌 Call 방식 파일 분석
- 파일 확장자에 상관없이 **헤더값(매직넘버)**을 확인
	- => 파일마다 고유한 매직넘버는 실제 확장자 값을 나타냄(?) 파일의 확장자를 바꾼다고 해서 매직넘버가 바뀌는 건 아니여서 파일 확장자 이름과는 별개로 매직넘버를 통해 해당 파일이 어떤 파일인지 확인할 수 있음

##### YARA RULE 탐지 #####
- YARA RULE 적용 후 탐지/분석 기능 제공
- YARA RULE 이란 문자열이나 바이너리 패턴을 기반으로 악성코드를 검색하며 이러한 악성코드를 분류할 수 있게 하는 도구임


---
## 3. SNIPER APT 주요 기능 ##

##### 세션 수집※(시험)※ #####
- 최대 10일
- 세션 정보를 이용하여 정보 추적 기능 제공

PE 파일에 대한 정책 자동 생성

##### Agent 기능※(시험)※ #####
- APT에서 악성파일을 탐지했다면 해당 파일에 대한 것을 정책으로 만들어서 모든 PC의 Agent에 배포함, 배포받은 Agent들은 실행을 차단함
- 악성파일이 내부로 침투가 되었더라도 APT에서 전달받은 내용으로 내부 PC의 Agent들이 악성파일의 실행은 차단할 수 있음

##### 악성메일 선격리 #####
- 악성메일 실시간 이메일 격리
- 메일에 포함된 첨부파일 악성 분석


ip, url을 보고 apt는 탐지함
yara rule은 파일을 탐지만 하는 룰이라서 차단은 안 됨


---
## 4. SNIPER APT 구성 ##

제품 형상
구성

In-Line 구성: 실시간 차단을 위해
Mirror 구성: 실시간 트래픽에 어떠한 영향도 안 줌, 그냥 탐지만 해서 다른 장비에 알리기만 함 (Span 모드와 비슷한가?)

##### MTA 구성 #####







---
---
# III. APT-T 5.1 설치 #



4. 설치 순서
	1. IP, DNS 설정
		- 명령어: sniper_network
	2. 환경 설정
		- 명령어: vi system_APT.conf
	3. NIC 설정 및 데몬 재기동
		- 명령어: vi sniper
	4. 장비 및 관계 등록 
		- GUI > 설정 > 장비 관리
	5. 정책 설정 및 배포
		- GUI > 정책 > 패턴 정책
	6. 시스템 점검 및 모니터링
		- GUI > 모니터링 > 대시보드



5. GUI 설정
	1. GUI 실행 전 GUI 설정을 해줘야함



---
---
# IV. GUI#


APT(CLI)
IP: 10.200.10.24:4000
계정
- 최고 관리자: sniper/Sniper12#
- 02번 관리자: root02/Sniper12#$


## 이벤트 ##
- 악성 파일 이벤트: HTTP, FTP를 이용한 악성 파일 다운로드 이벤트
- 악성 메일 이벤트: POP3, SMTP, MTA를 이용한 악성 파일 다운로드 이벤트
- 네트워크 이벤트
	- 네트워크 센서의 탐지/차단 이벤트
	- IPS에서 하는 것처럼 패킷을 탐지할 수 있음


## 분석이력 ##
- 파일이력: 모든 파일의 이력이 다 뜸(정상, 악성 다 포함)
- 메일 이력(첨부): 메일에서 첨부된 파일이 있으면 해당 메일만 올림
- 메일 이력(전체): 모든 메일이 다 보이는데 정보 보안적인 이유 때문에 메일 내용은 안 보임


## 파일 유형 ##

|  분류   |                            파일 유형                             |              비고               |
| :---: | :----------------------------------------------------------: | :---------------------------: |
| 압축 파일 |            zip, gzip, rar, tar, cab, iso, 7z, bz             | 압축 해제 후, 분석(암호화된 압축파일은 분석 불가) |
| 문서 파일 |        dox, docx, ppt, pptx, xls, xlsx, rtf, hwp, pdf        |     정적 분석, 문서 분석(DANA) 대상     |
| 실행 파일 | PE32, PE64 js<br>\* PE(Portable Executable): ext, dll, sys 등 |        정적 분석, 동적 분석 대상        |
|  기타   |                  apk, chm, jar, pif, scr 등                   |           정적 분석 대상            |

## 로그 추적 ##
※사용자 분석※: 파일을 업로드를 해서 여기서 해당 파일을 분석할 수 있고 분석결과를 볼 수 있음 
분석 결과에서 파일을 따로 우측 상단의 '조치'를 통해서 블랙리스트/화이트리스트에 등록할 수도 있음

![[Pasted image 20260119162127.png]]



- ## 정책 ##
	- ### 패턴 정책 ###
		-  실제 차단 등의 처리가 가능함, 블랙/화이트 리스트에 올려서 차단 또는 예외처리가 가능함
		- 사용자 정의 
			- Whitelist: 예외처리 하겠다
				- 입력된 IP/URL을 허용하며 파일 수집 대상에서 제외
			-  Blacklist: 이녀석은 차단하겠다.
				- 입력된 IP/URL 차단 (IP의 경우 Service=ANY)
				- 차단 = 탐지 + 차단
				- 유효 시간 0 = 무제한
	- ### 평판 정책 ###
		- 평판 정책은 정상 또는 악성파일로 **분류**하는 정책임, 따로 차단하지는 않음
		- 예를 들어서 정상 파일인데 악성 파일로 들어온다면 해당 파일을 화이트리스트에 올려서 정상파일로 **분류**함
		  반대로 악성 파일인데 정상 파일로 들어온다면 해당 파일을 블랙리스트에 올려서 악성파일로 **분류**함
	- ### URL 분석 정책 ###
		- 
	- ### 사용자 YARA ###
		- 


YARA RULE 적용하면 
탐지된 애들이 악성이면  YARA RULE에 등록되는 게 아니라 이미 악성파일로 알려진 애들이 YARA RULE에 등록됨
그래서 YARA RULE에 탐지가 되면 **무조건** 악성파일임




### 설정 ###


환경설정 - 권한설정에서 최고 관리자에게 원본파일 다운로드 권한이 생김

단, 정상파일 원본파일이 아니라 악성파일의 원본파일만 제공됨 Because 정상파일 중에는 민감한 파일도 있을텐데 그것까지 보안회사에서 다 보면 좀 글찮슴. 그래서 원본파일을 다운받을 때는 정상파일을 제외한 악성파일의 원본만 다운받을 수 있음




# 에이전트 #

대시보드: 설치된 에이전트 확인
에이전트 관리: 각 에이전트가 설치되어 있는 컴퓨터를 확인할 수 있음
에이전트가 APT에 10분 주기로 통신을 시도해서 APT가 삭제되면 에이전트가 

에이전트 정책 버전이 맞는지 확인하려면 내 컴퓨터의 에이전트 정책 정보를 확인하면 됨
![[Pasted image 20260119163825.png]]

![[Pasted image 20260119163849.png]]

![[Pasted image 20260119163901.png]]


에이전트의 ip가 바뀌어도 이미 에이전트가 배포됐으니까 사용할 수 있음(?)


에이전트 정책 - 랜섬웨어 공격
- 신뢰 프로세스: 신뢰할만 하니까 예외함
- 탐지 예외 경로: 자주 건드리는 경로를 추가하면 해당 경로는 건드려도 문제 없음

ON으로 하면 C에 \$$가 생기니까 가지고 놀아보기



에이전트 정책 - 파일 탐지
- 실시간 탐지를 켜놓으면 격리가 즉시 됨
- 사용자 정책에서 악성으로 격리된 정상 파일을 복구하고 싶으면 파일의 원본 파일을 넣어서 복구도 가능함



어플리케이션 제어
- 추가한 실행 프로그램의 이름을 통해서 격리함
- 기능이 정말 단순하게 1차원적임


에이전트 로그









환경 설정

로그인 설정에서 전부 다 0으로 해두면 문제 없다! 0이라면!






---
---
# V. CLI#

APT(CLI)
IP: 10.200.10.24
계정: root/sniper!#@$

sniper_network
eth0번이 MGMT 인터페이스이다.



### NIC ###

LLCF: 한 쪽 포트가 다운되면 다른 쪽 포트도 다운시켜서 패킷 누실을 방지함
한 쪽 포트가 다운됐는데 다른 쪽 포트가 열려있으면 패킷이 누실될 수 있음

LLCF가 다 켜져 있어서  

















---
---















#질문
- 인라인 구성과 미러 구성을 배울 때 미러 구성은 따로 못 봤던 거 같은데 탐지만 한다는 게 Span 모드와 비슷해 보이는데 IPS나 DDoS 장비의 Span 모드와 비슷한가?
	- => Span 모드와 미러 모드는 동작 하는 것 자체는 거의 같지만 장비 구성에서 차이가 있음
	  네트워크 구성이 In-Line인 경우에는 APT가 중간에 위치해서 APT를 통과하는 패킷이나 파일을 복사해서 탐지함
	  이때 NIC와 같은 APT의 연결부분에 문제가 생겨서 By-Pass도 안 되는 상황이 생길 수 있음
	  하지만 Mirror 구성으로 하게 되면 L2 Switch가 중간에 위치하고 APT는 옆에서 L2 Switch를 지나가는 패킷을 복사해서 탐지하고 알리기만함
	  그렇기 때문에 APT가 조각조각 부서져도 실제 서비스에는 아무런 영향을 안 미치기 때문에 서비스에 영향이 가는 걸 극도록 꺼리는 고객사들은 In-Line 구성보다 Mirror 구성을 선호하는 경우가 있음
![[Pasted image 20260119140831.png]]



- 43p의 /home1/sniper/bin/isconfig wins 가 어떤 명령어인가? 앞에 cd와 같은 '명령어'가 안 붙어있는데 이것이 무엇인가
	- => 리눅스에서 명령어가 없이 바로 절대경로가 입력되면 이건 해당 경로의 파일을 실행하라는 의미가 됨 따라서
	- /home1/sniper/bin/isconfig wins ->
		  cd /home1/sniper/bin
		  ./isconfig wins
		  이렇게 두 줄이 같은 의미를 나타냄
		  
- APT에서도 ips와 같이 패킷을 보고 ip 기반 차단 등의 기능을 수행할 수 있음 -> IPS가 고장났을 때 APT가 어느정도 IPS의 기능을 땜빵할 수 있는가?
	- => 일부분은 할 수 있지만 APT가 IPS의 기능을 다 대체할 수는 없음, APT에서 필요한 정도만큼만 IPS의 기능을 할 수 있기 때문에 APT가 IPS를 대체하여 쓸 수는 없음
	
- 최고 관리자는 APT 장비에 단 하나만 존재하는 것인가? 최고 관리자가 둘 이상이려면 APT 장비가 둘 이상이어야 하는가?
	- => 맞음, 조건이 붙으면 다른 경우도 있지만 기본적으로는 각 APT는 다 하나씩의 최고 관리자를 가짐



